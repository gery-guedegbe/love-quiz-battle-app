name: Keep Server Alive

on:
  # Ex√©cution automatique toutes les 12 minutes
  schedule:
    # Format: minute heure jour mois jour-semaine
    # Toutes les 12 minutes: */12 * * * *
    # Pour tester, vous pouvez utiliser: */5 * * * * (toutes les 5 minutes)
    - cron: "*/12 * * * *"

  # Permet aussi de d√©clencher manuellement depuis GitHub
  workflow_dispatch:

jobs:
  ping-server:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Ping Server Health Endpoint
        env:
          # R√©cup√®re l'URL du serveur depuis les secrets GitHub
          # Configurez ce secret dans: Settings > Secrets and variables > Actions
          SERVER_URL: ${{ secrets.BACKEND_URL }}
        run: |
          if [ -z "$BACKEND_URL" ]; then
            echo "‚ùå ERREUR: BACKEND_URL n'est pas d√©fini!"
            echo "üìù Configurez le secret BACKEND_URL dans:"
            echo "   Settings > Secrets and variables > Actions > New repository secret"
            echo "   Nom: BACKEND_URL"
            echo "   Valeur: https://votre-app.onrender.com"
            exit 1
          fi

          echo "üè• Pinging server health endpoint: $BACKEND_URL/api/health"

          # Fait une requ√™te GET vers l'endpoint health
          response=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$BACKEND_URL/api/health" || echo "000")

          if [ "$response" = "200" ]; then
            echo "‚úÖ Server is alive! (HTTP $response)"
            echo "‚è∞ Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
            exit 0
          else
            echo "‚ùå Server health check failed! (HTTP $response)"
            echo "‚ö†Ô∏è  This might mean the server is sleeping or there's an issue."
            echo "‚è∞ Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
            # On ne fait pas √©chouer le workflow pour √©viter les notifications inutiles
            # Le serveur se r√©veillera au prochain ping
            exit 0
          fi
